# 横向格式菜单餐次分类实施计划

## 项目概述

本实施计划旨在修复横向格式菜单餐次分类问题，使1月菜单文件能够正确显示早餐、午餐、晚餐分类，而不是将所有菜品归类为同一餐次。

## 任务列表

### 阶段1：核心算法实现

- [x] 1.1 创建餐次分段识别器
  - 创建`MealSegmentIdentifier`类
  - 实现餐次分隔符识别逻辑（"类别"行、空行、餐次标识）
  - 实现`MealSegment`数据结构
  - 添加基础的分段识别算法
  - _需求: 2.1, 2.3_

- [x] 1.2 实现智能餐次推断算法
  - 实现基于内容特征的餐次类型推断
  - 定义早餐、午餐、晚餐的特征分类和关键词
  - 实现关键词匹配和评分算法
  - 添加默认餐次分配策略
  - _需求: 2.2, 2.4_

- [x] 1.3 实现分段验证和调整逻辑
  - 实现餐次分段的合理性验证
  - 添加分段数量的智能调整（1个→午餐，2个→早+午，3个→早+午+晚）
  - 处理异常情况和边界条件
  - 确保餐次顺序的正确性
  - _需求: 2.5, 3.3_

### 阶段2：横向解析器重构

- [x] 2.1 重构横向格式解析器主方法
  - 修改`_parse_horizontal_weekly_format`方法
  - 集成餐次分段识别器
  - 实现多餐次的菜单数据生成
  - 保持原有的星期列识别和日期计算逻辑
  - _需求: 1.1, 1.2_

- [x] 2.2 实现分段菜品提取方法
  - 创建`_extract_items_from_segment`方法
  - 从指定餐次分段中提取菜品数据
  - 保持菜品和分类的原始顺序
  - 处理多菜品分割和清理
  - _需求: 1.3, 1.4_

- [x] 2.3 添加回退机制
  - 实现`_parse_horizontal_weekly_format_with_fallback`方法
  - 保留原始单餐次解析作为回退方案
  - 添加错误处理和日志记录
  - 确保向后兼容性
  - _需求: 5.4, 5.5_

### 阶段3：辅助功能实现

- [x] 3.1 优化日期和时间处理
  - 确保餐次时间设置正确（早餐7:30，午餐12:00，晚餐18:00）
  - 优化基准日期提取逻辑
  - 处理跨年日期计算（如果需要）
  - 验证日期格式的一致性
  - _需求: 4.1, 4.2, 4.3_

- [x] 3.2 增强错误处理和日志
  - 添加详细的解析过程日志
  - 实现餐次识别的调试信息
  - 改进错误消息的可读性
  - 添加性能监控日志
  - _需求: 3.5, 5.3_

- [ ] 3.3 实现配置支持
  - 添加餐次分类功能的开关配置
  - 支持自定义餐次时间配置
  - 支持自定义分隔符模式配置
  - 实现配置验证和默认值
  - _需求: 4.4_

### 阶段4：测试实现

- [ ] 4.1 编写单元测试
  - 测试`MealSegmentIdentifier`的各种分段场景
  - 测试餐次类型推断的准确性
  - 测试分段验证和调整逻辑
  - 测试边界条件和异常情况
  - _需求: 5.1, 5.2_

- [ ] 4.2 编写集成测试
  - 测试完整的横向格式解析流程
  - 使用真实的1月菜单文件进行测试
  - 验证多餐次解析的正确性
  - 测试回退机制的有效性
  - _需求: 5.3, 5.4_

- [ ] 4.3 编写回归测试
  - 确保现有纵向格式解析不受影响
  - 测试其他Excel格式的兼容性
  - 验证API接口的响应格式
  - 测试前端显示的正确性
  - _需求: 5.5_

### 阶段5：性能优化和监控

- [ ] 5.1 性能优化
  - 优化餐次识别算法的时间复杂度
  - 减少不必要的数据复制和转换
  - 实现结果缓存（如果适用）
  - 测试大文件的处理性能
  - _需求: 技术约束_

- [ ] 5.2 实现监控指标
  - 创建`HorizontalMealClassificationMetrics`类
  - 记录餐次识别的成功率和统计信息
  - 监控回退机制的使用频率
  - 添加性能指标收集
  - _需求: 监控需求_

- [ ] 5.3 添加调试和诊断工具
  - 实现餐次分段的可视化调试
  - 添加解析过程的详细日志
  - 创建诊断API端点（可选）
  - 提供解析结果的验证工具
  - _需求: 开发支持_

### 阶段6：部署和验证

- [x] 6.1 本地环境测试
  - 在开发环境测试1月菜单文件
  - 验证餐次分类显示正确
  - 测试前端界面的餐次展示
  - 确认用户体验改善
  - _需求: 1.1, 1.4_

- [x] 6.2 数据验证和修复
  - 检查现有1月菜单数据的解析结果
  - 如果需要，重新解析和存储数据
  - 验证API返回的餐次信息
  - 确认前端显示的准确性
  - _需求: 1.2, 1.3_

- [ ] 6.3 生产环境准备
  - 更新部署配置包含新功能
  - 准备功能开关和回滚方案
  - 测试生产环境的兼容性
  - 制定监控和告警策略
  - _需求: 部署需求_

## 里程碑和时间计划

### 里程碑1：核心算法完成 (预计1天)
- 餐次分段识别器实现完成
- 智能推断算法基本可用
- 基础单元测试通过

### 里程碑2：解析器重构完成 (预计1天)
- 横向格式解析器支持多餐次
- 回退机制实现完成
- 集成测试基本通过

### 里程碑3：功能完整性验证 (预计0.5天)
- 1月菜单文件正确解析为多餐次
- 前端界面正确显示餐次分类
- 用户体验问题解决

### 里程碑4：优化和部署 (预计0.5天)
- 性能优化完成
- 监控指标实现
- 生产环境部署准备

## 验收标准

### 功能验收
- [ ] 1月菜单文件解析出多个餐次（早餐、午餐、晚餐）
- [ ] 每个餐次包含正确的菜品分类
- [ ] 餐次时间设置合理（早餐7:30，午餐12:00，晚餐18:00）
- [ ] 前端界面正确显示餐次分组

### 技术验收
- [ ] 所有单元测试通过
- [ ] 集成测试覆盖主要场景
- [ ] 回归测试确保兼容性
- [ ] 性能指标不低于现有水平

### 用户体验验收
- [ ] 菜单显示结构清晰
- [ ] 餐次分组逻辑合理
- [ ] 加载速度不受明显影响
- [ ] 错误处理友好

## 风险管理

### 高风险项目
1. **解析准确性风险**
   - 风险：餐次识别可能不准确
   - 缓解：多种识别策略，充分测试，回退机制

2. **兼容性风险**
   - 风险：可能影响其他格式的解析
   - 缓解：保留原始方法，全面回归测试

### 中风险项目
1. **性能影响**
   - 风险：新算法可能增加处理时间
   - 缓解：算法优化，性能测试

2. **用户体验中断**
   - 风险：部署过程中可能出现问题
   - 缓解：渐进部署，快速回滚

### 应急预案
1. **功能开关**
   - 实现配置开关，可快速禁用新功能
   - 回退到原始单餐次解析

2. **数据修复**
   - 准备数据重新解析脚本
   - 备份现有解析结果

## 实施注意事项

### 开发优先级
1. **用户体验优先** - 优先解决1月菜单显示问题
2. **稳定性保证** - 确保不影响现有功能
3. **性能考虑** - 保持解析速度在可接受范围

### 测试重点
1. **真实数据测试** - 使用实际的1月菜单文件
2. **边界情况** - 测试各种异常和特殊格式
3. **兼容性验证** - 确保其他格式正常工作

### 部署策略
1. **本地验证** - 先在开发环境充分测试
2. **渐进部署** - 可考虑先部署到测试环境
3. **监控告警** - 部署后密切监控解析结果

## 总结

横向格式菜单餐次分类是一个重要的用户体验改进，通过实现智能的餐次识别算法，可以让1月菜单正确显示早餐、午餐、晚餐分类。

**项目特点：**
- **影响直接** - 立即改善用户体验
- **风险可控** - 有回退机制保证稳定性
- **实施快速** - 预计3天内完成
- **价值明显** - 解决用户反馈的实际问题

通过分阶段实施和充分测试，可以确保功能的正确性和稳定性，为用户提供更好的菜单浏览体验。