# 跨年日期处理实施计划

## 项目概述

本实施计划旨在解决食堂菜单系统在处理跨年菜单文件时的年份判断错误问题，实现智能的年份推断机制，确保12月菜单正确识别为2025年，1月菜单正确识别为2026年。

## 任务列表

### 阶段1：核心算法实现

- [ ] 1.1 实现智能年份推断算法
  - 创建`infer_year_for_month`函数，基于月份和当前时间推断年份
  - 实现基于时间窗口的推断策略
  - 实现基于月份距离的推断策略（备选方案）
  - 添加配置支持，允许选择推断策略
  - _需求: 2.1, 2.2, 2.5_

- [ ] 1.2 增强日期提取器
  - 创建`EnhancedDateExtractor`类
  - 支持从文件名提取完整日期（包含年份）
  - 支持月日格式的智能年份推断
  - 处理日期范围格式（如：12月8-12日）
  - _需求: 1.1, 1.3_

- [ ] 1.3 实现跨年日期范围处理
  - 创建`handle_cross_year_range`函数
  - 处理跨年的日期范围（如：12月29日-1月2日）
  - 验证日期范围的合理性
  - 处理闰年等特殊情况
  - _需求: 1.5, 2.4_

### 阶段2：Excel解析器改造

- [ ] 2.1 更新Excel解析器核心逻辑
  - 修改`parse_excel_file`方法，集成新的年份推断
  - 更新文件名日期提取逻辑
  - 替换所有使用`current_year()`的地方
  - 确保向后兼容性
  - _需求: 1.1, 1.2_

- [ ] 2.2 优化星期格式解析
  - 更新`_parse_weekly_format`方法
  - 在星期格式中应用年份推断
  - 处理跨年的星期格式菜单
  - 验证日期映射的正确性
  - _需求: 1.3, 2.3_

- [ ] 2.3 增强横向格式解析
  - 更新`_parse_horizontal_weekly_format`方法
  - 应用智能年份推断到横向格式
  - 处理横向格式中的跨年情况
  - 确保日期生成的准确性
  - _需求: 1.4, 2.2_

### 阶段3：数据存储优化

- [ ] 3.1 实现跨年菜单存储
  - 创建`CrossYearMenuStorage`类（可选，或扩展现有存储）
  - 按年份分组存储菜单数据
  - 创建日期到年份的索引
  - 优化跨年日期查询性能
  - _需求: 3.3, 3.4_

- [ ] 3.2 添加日期范围查询功能
  - 实现`get_available_dates_in_range`方法
  - 支持跨年的日期范围查询
  - 优化查询性能和内存使用
  - 添加日期排序功能
  - _需求: 3.2, 3.5_

- [ ] 3.3 数据一致性验证
  - 实现菜单数据年份一致性检查
  - 添加重复日期检测和处理
  - 实现数据完整性验证
  - 创建数据修复工具
  - _需求: 5.4, 5.5_

### 阶段4：API接口增强

- [ ] 4.1 新增跨年日期查询API
  - 创建`/api/menu/range`端点
  - 支持跨年的日期范围查询
  - 添加参数验证和错误处理
  - 优化响应格式和性能
  - _需求: 3.2, 3.3_

- [ ] 4.2 更新现有API接口
  - 确保`/api/menu`端点支持跨年日期
  - 更新`/api/dates`端点返回完整年份信息
  - 添加年份信息到响应数据
  - 保持API向后兼容性
  - _需求: 1.4, 3.4_

- [ ] 4.3 添加年份推断信息API
  - 创建调试和监控用的API端点
  - 返回年份推断的详细信息
  - 提供日期解析的诊断功能
  - 支持配置查询和修改
  - _需求: 5.1, 5.3_

### 阶段5：前端适配

- [ ] 5.1 更新日期格式化函数
  - 修复`formatDateString`函数的时区问题
  - 确保日期格式化不受时区偏移影响
  - 统一前端的日期处理逻辑
  - 添加年份显示支持
  - _需求: 3.1, 3.2_

- [ ] 5.2 增强月历组件
  - 更新`DateSelector`组件支持跨年导航
  - 改进月历的年份显示
  - 优化跨年边界的用户体验
  - 添加年份快速跳转功能
  - _需求: 3.1, 3.5_

- [ ] 5.3 优化菜单显示组件
  - 更新`MenuDisplay`组件显示完整日期
  - 改进跨年菜单的排序显示
  - 添加年份信息到菜单卡片
  - 优化日期导航的用户体验
  - _需求: 1.4, 3.4_

### 阶段6：测试实现

- [ ] 6.1 编写年份推断单元测试
  - 测试各种月份和时间组合的年份推断
  - 测试边界情况（12月31日、1月1日等）
  - 测试不同推断策略的正确性
  - 测试配置参数的影响
  - _需求: 4.1, 4.2_

- [ ] 6.2 编写文件解析测试
  - 测试各种文件名格式的日期提取
  - 测试跨年文件的解析正确性
  - 测试日期范围解析功能
  - 测试错误情况的处理
  - _需求: 4.1, 4.3_

- [ ] 6.3 编写集成测试
  - 测试完整的跨年菜单加载流程
  - 测试API接口的跨年功能
  - 测试前端组件的跨年显示
  - 测试数据一致性和完整性
  - _需求: 4.2, 4.4_

- [ ] 6.4 编写性能测试
  - 测试年份推断算法的性能
  - 测试跨年查询的响应时间
  - 测试大量跨年数据的处理能力
  - 优化性能瓶颈
  - _需求: 4.5_

### 阶段7：数据迁移和修复

- [ ] 7.1 实现现有数据迁移工具
  - 创建`migrate_existing_menu_data`函数
  - 扫描现有菜单数据的年份问题
  - 自动修正错误的年份标记
  - 生成迁移报告和日志
  - _需求: 5.4_

- [ ] 7.2 执行数据迁移
  - 备份现有菜单数据
  - 执行年份修正迁移
  - 验证迁移结果的正确性
  - 处理迁移过程中的异常情况
  - _需求: 1.1, 1.2_

- [ ] 7.3 验证迁移后数据
  - 检查所有日期的年份正确性
  - 验证跨年导航功能
  - 确认用户界面显示正确
  - 测试API返回数据的准确性
  - _需求: 1.3, 1.4_

### 阶段8：监控和日志

- [ ] 8.1 添加跨年处理日志
  - 在年份推断时记录详细日志
  - 记录文件解析过程中的年份决策
  - 添加异常情况的错误日志
  - 实现日志级别配置
  - _需求: 5.1, 5.2_

- [ ] 8.2 实现监控指标
  - 创建`CrossYearMetrics`类
  - 统计年份推断的使用情况
  - 监控跨年文件处理数量
  - 记录日期解析错误率
  - _需求: 5.3, 5.5_

- [ ] 8.3 添加健康检查
  - 实现跨年数据一致性检查
  - 添加年份推断功能的健康检查
  - 监控系统启动时的数据验证
  - 提供诊断和修复建议
  - _需求: 5.4, 5.5_

### 阶段9：配置和部署

- [ ] 9.1 添加配置管理
  - 实现年份推断策略配置
  - 添加时间窗口参数配置
  - 支持跨年验证开关配置
  - 实现配置热更新功能
  - _需求: 2.5_

- [ ] 9.2 更新部署文档
  - 更新README.md说明跨年功能
  - 添加配置参数说明
  - 更新API文档包含新接口
  - 创建故障排查指南
  - _需求: 5.2_

- [ ] 9.3 准备生产部署
  - 更新Docker配置支持新功能
  - 测试生产环境的跨年处理
  - 准备回滚方案和应急预案
  - 制定部署检查清单
  - _需求: 5.4_

## 里程碑和时间计划

### 里程碑1：核心算法完成 (预计2天)
- 年份推断算法实现完成
- 日期提取器增强完成
- 基础测试通过

### 里程碑2：解析器改造完成 (预计2天)
- Excel解析器集成新算法
- 所有解析格式支持跨年
- 解析功能测试通过

### 里程碑3：存储和API完成 (预计1-2天)
- 跨年数据存储优化完成
- API接口增强完成
- 集成测试通过

### 里程碑4：前端适配完成 (预计1天)
- 前端组件支持跨年显示
- 用户界面测试通过
- 用户体验验证完成

### 里程碑5：数据迁移完成 (预计1天)
- 现有数据迁移完成
- 数据一致性验证通过
- 生产环境准备就绪

## 风险管理

### 高风险项目
1. **数据迁移风险**
   - 风险：现有菜单数据可能丢失或损坏
   - 缓解：完整备份，分步迁移，回滚方案

2. **年份推断错误**
   - 风险：算法可能在某些边界情况下判断错误
   - 缓解：全面测试，多种策略备选，人工验证

3. **用户体验中断**
   - 风险：跨年导航可能出现异常
   - 缓解：渐进式部署，用户反馈收集

### 中风险项目
1. **性能影响**
   - 风险：年份推断可能增加处理时间
   - 缓解：算法优化，性能测试，缓存策略

2. **API兼容性**
   - 风险：新API可能影响现有客户端
   - 缓解：向后兼容设计，版本控制

### 应急预案
1. **快速回滚**
   - 保留原始数据备份
   - 准备配置开关快速禁用新功能

2. **问题隔离**
   - 分阶段部署验证
   - 监控关键指标及时发现问题

## 验收标准

### 功能验收
- [ ] 12月菜单正确显示为2025年
- [ ] 1月菜单正确显示为2026年
- [ ] 跨年日期导航流畅无误
- [ ] 所有现有功能保持正常

### 技术验收
- [ ] 所有单元测试通过
- [ ] 集成测试覆盖跨年场景
- [ ] 性能指标不低于现有水平
- [ ] API接口向后兼容

### 用户体验验收
- [ ] 日期显示准确清晰
- [ ] 月历导航直观易用
- [ ] 菜单搜索结果正确
- [ ] 错误提示友好明确

## 后续维护

### 持续监控
- 跨年处理的准确性监控
- 年份推断算法的效果评估
- 用户反馈收集和分析

### 定期维护
- 年度边界情况的验证
- 算法参数的调优
- 新年份数据的预处理

### 功能扩展
- 支持更多日期格式
- 增加年份推断的智能化
- 优化跨年查询性能

## 总结

跨年日期处理是一个重要的功能改进，需要系统性的设计和实施。通过智能的年份推断算法、增强的文件解析能力和优化的用户体验，系统将能够正确处理跨年菜单，为用户提供准确、流畅的菜单浏览体验。

项目预计需要7-10天完成，通过分阶段实施和充分测试，可以确保功能的稳定性和可靠性。