<!--
同步影响报告
================================================================================
版本变更: 初始模板 → 1.0.0

修改的原则:
- 新增: I. 前后端分离架构
- 新增: II. 自动化优先
- 新增: III. 数据驱动设计
- 新增: IV. 容器化部署

新增章节:
- 技术栈约束
- 质量标准

需要更新的模板:
- ✅ plan-template.md - 已验证技术栈上下文
- ✅ spec-template.md - 已验证需求格式
- ✅ tasks-template.md - 已验证任务组织

待办事项:
- 无

================================================================================
-->

# 食堂菜单系统宪章

## 核心原则

### I. 前后端分离架构

系统必须采用前后端分离架构，确保开发独立性和部署灵活性。

**规则**:
- 前端必须使用 React + TypeScript + Vite 技术栈独立开发
- 后端必须使用 Flask + Flask-RESTX 提供 RESTful API
- 前端开发环境独立运行（端口 3000），通过 Vite 代理访问后端
- 生产环境前端构建到 `backend/static/`，由 Flask 统一服务
- API 端点必须遵循 RESTful 设计原则
- CORS 配置必须区分开发环境和生产环境

**理由**: 前后端分离允许独立开发、测试和部署，提高团队协作效率。生产环境统一服务简化部署架构，降低运维复杂度。

### II. 自动化优先

系统必须最大化自动化，减少人工干预和操作错误。

**规则**:
- 应用启动时必须自动扫描 `menu/` 目录并加载 Excel 文件
- 支持多种 Excel 格式（.xlsx, .xls, .et, .csv）自动识别和解析
- 必须提供 API 端点支持手动触发刷新
- 静态文件路由必须在 API 路由之前注册，确保 SPA 路由正确回退
- 餐次识别必须自动处理，支持横向和纵向格式菜单
- Docker 容器重启后必须自动重新扫描菜单文件

**理由**: 自动化减少用户操作负担，避免手动上传和配置错误，确保系统始终展示最新菜单数据。

### III. 数据驱动设计

系统必须以数据为中心，确保数据的准确性、一致性和可追溯性。

**规则**:
- 所有菜单数据必须来源于 `menu/` 目录下的 Excel 文件
- 数据存储必须使用内存单例模式（`app/models/storage.py`）
- Excel 解析器必须支持中文列名和灵活的列结构
- 时区处理必须使用 `TZ` 环境变量配置（默认 `Asia/Shanghai`）
- API 响应必须包含完整的日期、餐次、菜品信息
- 数据扫描状态必须可查询（`/api/scanner/status`）

**理由**: 单一数据源避免数据不一致，内存存储简化架构，时区配置确保跨地域部署的准确性。

### IV. 容器化部署

系统必须使用 Docker 容器化部署，确保环境一致性和可移植性。

**规则**:
- 必须提供多阶段构建 Dockerfile（前端构建 + 后端运行）
- 必须使用 Docker Compose 简化部署配置
- 容器必须支持环境变量配置（`FLASK_ENV`, `TZ`）
- `menu/` 目录必须通过卷挂载持久化
- 容器必须配置健康检查（`/api/health` 端点，间隔 30 秒）
- 重启策略必须设置为 `unless-stopped`
- 前端构建必须在容器内完成，无需本地构建

**理由**: 容器化确保开发、测试、生产环境一致性，简化部署流程，提高系统可维护性。

## 技术栈约束

### 前端技术栈

- **框架**: React 18 + TypeScript（严格模式）
- **构建工具**: Vite
- **UI 框架**: Bootstrap 5 + Bootstrap Icons
- **HTTP 客户端**: Axios
- **包管理器**: pnpm（必须使用，不使用 npm）
- **代码规范**: ESLint + Prettier
- **测试框架**: Jest + React Testing Library + fast-check

### 后端技术栈

- **框架**: Flask 2.3.3 + Flask-RESTX
- **数据处理**: pandas + openpyxl + xlrd
- **Python 版本**: 3.11+
- **代码规范**: PEP 8 + black + flake8 + mypy（类型注解）
- **测试框架**: pytest + pytest-cov + hypothesis
- **数据验证**: marshmallow

### 部署技术栈

- **容器化**: Docker + Docker Compose
- **镜像**: Python 3.11 Slim + Node.js 18 Alpine
- **端口映射**: 宿主机 1214 → 容器 5000
- **健康检查**: `/api/health`

## 质量标准

### 代码质量

- 前端必须通过 ESLint 检查（`pnpm run lint`）
- 后端必须通过 black、flake8、mypy 检查
- 所有新增代码必须有类型注解（后端）或类型定义（前端）
- Git 提交必须使用中文，遵循 Conventional Commits 规范（feat, fix, docs 等）

### 测试要求

- 后端测试覆盖率应不低于 60%（pytest-cov）
- 前端测试应覆盖核心组件和关键用户流程
- 测试文件与源码同目录（`.test.tsx` 或 `.test.py`）

### 性能要求

- API 响应时间应低于 200ms（P95）
- 前端首次内容绘制（FCP）应低于 2 秒
- 支持至少 1000 个并发用户访问

### 安全要求

- 生产环境 CORS 配置为 `origins="*"`（当前无身份验证）
- 所有用户输入必须通过 marshmallow 验证
- 避免注入攻击（SQL、XSS、命令注入）
- 敏感信息不得硬编码（使用环境变量）

## 开发工作流

### 分支策略

- `main` - 主分支，保持稳定可部署状态
- `feature/###-feature-name` - 功能分支
- `fix/###-bug-fix` - 修复分支

### 提交规范

```
<type>: <subject>

类型 (type):
- feat: 新功能
- fix: 修复 bug
- docs: 文档更新
- style: 代码格式（不影响功能）
- refactor: 重构（不是新功能也不是修复）
- test: 测试相关
- chore: 构建/工具链相关
```

### 代码审查

- 所有 PR 必须通过 CI/CD 检查
- 代码审查必须关注：安全性、性能、可维护性
- 复杂度增加必须在 PR 中说明理由

## 治理

### 宪章优先级

本宪章优先级高于所有其他实践和规范。在发生冲突时，以宪章为准。

### 修订流程

1. 提出修订建议（说明理由和影响范围）
2. 更新宪章文档并增加版本号
3. 同步更新所有依赖模板和指导文档
4. 通知团队成员并记录修订历史

### 版本控制

遵循语义化版本规则：
- **MAJOR**: 移除或重新定义核心原则（不兼容的治理变更）
- **MINOR**: 新增原则或实质性扩展指导
- **PATCH**: 澄清、措辞改进、非语义优化

### 合规性审查

- 所有 PR 必须验证是否符合宪章原则
- 代码审查时必须检查复杂度是否合理
- 开发过程中必须参考 [CLAUDE.md](../../CLAUDE.md) 获取运行时指导

### 复杂度管理

- 简单性优于灵活性，避免过度设计
- 新增依赖必须有明确理由
- 架构复杂性必须在 plan.md 中记录并说明

**版本**: 1.0.0 | **批准日期**: 2026-01-05 | **最后修订**: 2026-01-05
